package com.example.kmpuniversalapp.libs.notification

import com.example.kmpuniversalapp.libs.utils.log.AppLogger

/**
 * 极光推送服务实现
 * 使用expect/actual模式实现平台特定功能
 */
expect class JPushService : NotificationService

/**
 * 极光推送配置
 */
data class JPushConfig(
    val appKey: String,
    val channel: String = "default",
    val debugMode: Boolean = false
)

/**
 * 极光推送服务实现 - 通用部分
 */
abstract class JPushServiceBase(
    private val config: JPushConfig
) : NotificationService {
    
    protected var isInitialized = false
    protected var deviceToken: String? = null
    
    override suspend fun initialize() {
        if (isInitialized) return
        
        AppLogger.d("JPushService", "Initializing JPush with appKey: ${config.appKey}")
        
        try {
            initializePlatform()
            isInitialized = true
            AppLogger.i("JPushService", "JPush initialized successfully")
        } catch (e: Exception) {
            AppLogger.e("JPushService", "Failed to initialize JPush", e)
            throw e
        }
    }
    
    override suspend fun registerToken(): String? {
        if (!isInitialized) {
            AppLogger.w("JPushService", "JPush not initialized, cannot register token")
            return null
        }
        
        try {
            deviceToken = registerTokenPlatform()
            AppLogger.i("JPushService", "Device token registered: $deviceToken")
            return deviceToken
        } catch (e: Exception) {
            AppLogger.e("JPushService", "Failed to register token", e)
            return null
        }
    }
    
    override suspend fun sendNotification(
        title: String,
        content: String,
        data: Map<String, String>
    ) {
        if (!isInitialized) {
            AppLogger.w("JPushService", "JPush not initialized, cannot send notification")
            return
        }
        
        try {
            sendNotificationPlatform(title, content, data)
            AppLogger.i("JPushService", "Notification sent: $title")
        } catch (e: Exception) {
            AppLogger.e("JPushService", "Failed to send notification", e)
        }
    }
    
    override suspend fun setUserTags(tags: Map<String, String>) {
        if (!isInitialized) {
            AppLogger.w("JPushService", "JPush not initialized, cannot set tags")
            return
        }
        
        try {
            setUserTagsPlatform(tags)
            AppLogger.i("JPushService", "User tags set: $tags")
        } catch (e: Exception) {
            AppLogger.e("JPushService", "Failed to set user tags", e)
        }
    }
    
    override suspend fun clearUserTags() {
        if (!isInitialized) {
            AppLogger.w("JPushService", "JPush not initialized, cannot clear tags")
            return
        }
        
        try {
            clearUserTagsPlatform()
            AppLogger.i("JPushService", "User tags cleared")
        } catch (e: Exception) {
            AppLogger.e("JPushService", "Failed to clear user tags", e)
        }
    }
    
    override suspend fun checkPermission(): NotificationPermission {
        return checkPermissionPlatform()
    }
    
    override suspend fun requestPermission(): Boolean {
        return requestPermissionPlatform()
    }
    
    // 平台特定实现方法
    protected abstract suspend fun initializePlatform()
    protected abstract suspend fun registerTokenPlatform(): String?
    protected abstract suspend fun sendNotificationPlatform(
        title: String,
        content: String,
        data: Map<String, String>
    )
    protected abstract suspend fun setUserTagsPlatform(tags: Map<String, String>)
    protected abstract suspend fun clearUserTagsPlatform()
    protected abstract suspend fun checkPermissionPlatform(): NotificationPermission
    protected abstract suspend fun requestPermissionPlatform(): Boolean
}
